<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.0 -->
    <script>
        window.materialVersion = "1.5.0"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">














    <!-- Title -->
    
    <title>
        
            Linux点点滴滴 | 
        
        Azurery
    </title>

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no"/>
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="Magicmanoooo">
    <meta name="description" itemprop="description" content="蒟蒻一枚">
    <meta name="keywords" content=",Linux">

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(window.oldVersion){var remove=window.oldVersion.reduce(function(p,c){return p||data.indexOf("/*"+c+"*/")!==-1},false);if(remove){lsloader.removeLS(key)}}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload,isJs){if(typeof cssonload==="boolean"){isJs=cssonload;cssonload=undefined}isJs=isJs||false;cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload,isJs);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload,isJs);return}code=code.split(versionString)[1];if(isJs){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload,isJs)}};lsloader.requestResource=function(name,path,cssonload,isJs){var that=this;if(isJs){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else{this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Azurery">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?MKetZV3cUTfDxvMffaOezg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        
            
                <style id="prettify_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_css","/css/prettify.min.css?zp8STOU9v89XWFEnN+6YmQ==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
                <style id="prettify_theme"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_theme","/css/prettify/vibrant-ink.min.css?e5E/qqGcGveS7VTH4M896w==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
            
        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-image: url(/img/bg.png);
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icon -->

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Linux点点滴滴 | Azurery">
    <meta property="og:image" content="http://yoursite.com/img/favicon.png" />
    <meta property="og:description" content="蒟蒻一枚">
    <meta property="og:article:tag" content="Linux"> 

    
        <meta property="article:published_time" content="Fri Oct 26 2018 11:17:17 GMT+0800" />
        <meta property="article:modified_time" content="Sat Oct 27 2018 21:39:19 GMT+0800" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="Linux点点滴滴 | Azurery">
    <meta name="twitter:description" content="蒟蒻一枚">
    <meta name="twitter:image" content="http://yoursite.com/img/favicon.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="http://yoursite.com" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://yoursite.com/2018/10/26/Linux点点滴滴/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://yoursite.com/2018/10/26/Linux点点滴滴/index.html",
    "headline": "Linux点点滴滴",
    "datePublished": "Fri Oct 26 2018 11:17:17 GMT+0800",
    "dateModified": "Sat Oct 27 2018 21:39:19 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "Magicmanoooo",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.png"
        },
        "description": "秘境，探寻你的足迹"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Azurery",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": ",Linux",
    "description": "蒟蒻一枚",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Linux内存管理"><span class="post-toc-number">1.</span> <span class="post-toc-text">Linux内存管理</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-虚拟内存地址与物理内存地址"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">1. 虚拟内存地址与物理内存地址</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-页与地址构成"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">2. 页与地址构成</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#内存页与磁盘页"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">内存页与磁盘页</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Linux进程级内存管理"><span class="post-toc-number">2.</span> <span class="post-toc-text">Linux进程级内存管理</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-内存排布"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1. 内存排布</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-Heap内存模型"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2. Heap内存模型</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#brk与sbrk"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">brk与sbrk</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-资源限制与rlimit"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">4. 资源限制与rlimit</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#实现malloc"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">实现malloc</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-采用的数据结构"><span class="post-toc-number">2.5.1.</span> <span class="post-toc-text">1. 采用的数据结构</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-寻找合适的block"><span class="post-toc-number">2.5.2.</span> <span class="post-toc-text">2. 寻找合适的block</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-开辟新的block"><span class="post-toc-number">2.5.3.</span> <span class="post-toc-text">3. 开辟新的block</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#分裂block"><span class="post-toc-number">2.5.4.</span> <span class="post-toc-text">分裂block</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#malloc的实现"><span class="post-toc-number">2.5.5.</span> <span class="post-toc-text">malloc的实现</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#calloc的实现"><span class="post-toc-number">2.5.6.</span> <span class="post-toc-text">calloc的实现</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#free的实现"><span class="post-toc-number">2.5.7.</span> <span class="post-toc-text">free的实现</span></a></li></ol></li></ol></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                Linux点点滴滴
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Magicmanoooo</strong>
        <span>10月 26, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    
        <button id="article-functions-qrcode-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">devices other</i>
    <span class="visuallyhidden">devices other</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-qrcode-button">
    <li class="mdl-menu__item">在其它设备中阅读本文章</li>
    
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACaElEQVR42u3a0U7DQAwEwP7/T8MrEiKs7Zwb0OQJVW1yE6Tzae3Xx7++Xnh4eHh4eHh4eA/jveLr+/d/us/XT35cRPGeydrw8PDwNnm/bLWtB1/fLXkRzbXh4eHhLfKui0H+4Ot7JkVltDY8PDy8h/Gqi8sP2dfPwsPDw/vrvORXOSl5HXh4eHjP5PUi1zxK6EXDq1kLHh4eXsyrNsA2/35Dfw8PDw/vklceaYqPtr0iMb/w8PDwTvOSA/FkMGv+zWrYgYeHh3eal2/l1SJRHT7ovehm3cPDw8Mb8OYBwfUWX+Xlv8LDw8N7L+/eAYJ5C63X+sLDw8Pb4eVl4K5ykryOSXCMh4eHt8NLNt9kQXl5SMYX8jvj4eHh7fPyA3R1DKsHrh738fDw8PZ5eWGojhckIwI5KVozHh4e3mFevuj8WHxXGNFcCR4eHt5hXrUFNY9089eRR7p4eHh4+7xqlDA5HM/LT7MBhoeHh3crrxfR5q2s6lhVNYDAw8PD2+T1tuDJkFbyzV7DDA8PD2+TVx3u742ZJkfzfGigkFLj4eHh3crLt+98u6+WlmpQe0PWgoeHh3eA1xwVDQrMpDBEh3I8PDy8w7xeo6t3BM8HWKvPwsPDw9vkldtLxUXnDa08wP3lX4KHh4d3mNfbjpN4onkgng9m4eHh4a3wkmKQxxZ5kejFFuUwAg8PD+8YL48Yypt1a+gqHxfAw8PDezKvGlL0hrSSQzkeHh7e3+JVt/VJVPGGwoCHh4d3IOfsjUwly+19goeHh7fPmzTA5sMEE9Lx0QE8PDy88dDV8y88PDw8PDw8PLwHXJ9l+1jc3G9DbwAAAABJRU5ErkJggg==">
    
</ul>

    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Linux/">Linux</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Linux点点滴滴&url=http://yoursite.com/2018/10/26/Linux点点滴滴/index.html&pic=http://yoursite.com/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Linux点点滴滴&url=http://yoursite.com/2018/10/26/Linux点点滴滴/index.html&via=Magicmanoooo" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2018/10/26/Linux点点滴滴/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com/2018/10/26/Linux点点滴滴/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=Azurery&title=Linux点点滴滴&summary=蒟蒻一枚&pics=http://yoursite.com/img/favicon.png&url=http://yoursite.com/2018/10/26/Linux点点滴滴/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h1 id="Linux内存管理"><a href="#Linux内存管理" class="headerlink" title="Linux内存管理"></a>Linux内存管理</h1><h2 id="1-虚拟内存地址与物理内存地址"><a href="#1-虚拟内存地址与物理内存地址" class="headerlink" title="1. 虚拟内存地址与物理内存地址"></a>1. 虚拟内存地址与物理内存地址</h2><p>为了简单，现代操作系统在处理内存地址时，普遍采用虚拟内存地址技术。即在汇编程序（或机器语言）层面，当涉及内存地址时，都是使用虚拟内存地址。采用这种技术时，每个进程仿佛自己独享一片<code>2^N</code>字节的内存，其中<code>N</code>是机器位数。</p>
<p>这种虚拟地址空间的作用主要是：简化程序的编写及方便操作系统对进程间内存的隔离管理，真实中的进程不太可能需要（也用不到）如此大的内存空间，实际能用到的内存取决于物理内存大小。</p>
<p>由于在机器语言层面都是采用虚拟地址，当实际的机器码程序涉及到内存操作时，需要根据当前进程运行的实际上下文将虚拟地址转换为物理内存地址，才能实现对真实内存数据的操作。这个转换一般由一个叫<code>MMU（Memory Management Unit）</code>的硬件完成。</p>
<h2 id="2-页与地址构成"><a href="#2-页与地址构成" class="headerlink" title="2. 页与地址构成"></a>2. 页与地址构成</h2><p>在现代操作系统中，不论是虚拟内存还是物理内存，都不是以字节为单位进行管理的，而是以页（Page）为单位。一个内存页是一段固定大小的连续内存地址的总称，具体到Linux中，典型的内存页大小为<code>4096</code> Byte（<code>4K</code>）。</p>
<p>所以内存地址可以分为页号和页内偏移量。下面以<code>64</code>位机器，<code>4G</code>物理内存，<code>4K</code>页大小为例，虚拟内存地址和物理内存地址的组成如下：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1351548-953dcf9afb766490.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>上面是虚拟内存地址，下面是物理内存地址。由于页大小都是<code>4K</code>，所以页内便宜都是用低<code>12</code>位表示，而剩下的高地址表示页号。</p>
<p>MMU映射单位并不是字节，而是页，这个映射通过查一个常驻内存的数据结构页表来实现。现在计算机具体的内存地址映射比较复杂，为了加快速度会引入一系列缓存和优化，例如<code>TLB</code>等机制。例如，经过简化的内存地址翻译示意图：<br><img src="https://upload-images.jianshu.io/upload_images/1351548-28e00e6e448cdd52.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h2 id="内存页与磁盘页"><a href="#内存页与磁盘页" class="headerlink" title="内存页与磁盘页"></a>内存页与磁盘页</h2><p>一般将内存看做磁盘的的缓存，有时MMU在工作时，会发现页表表明某个内存页不在物理内存中，此时会触发一个缺页异常（Page Fault），此时系统会到磁盘中相应的地方将磁盘页载入到内存中，然后重新执行由于缺页而失败的机器指令。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1351548-2f94669c01c9097b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h1 id="Linux进程级内存管理"><a href="#Linux进程级内存管理" class="headerlink" title="Linux进程级内存管理"></a>Linux进程级内存管理</h1><h2 id="1-内存排布"><a href="#1-内存排布" class="headerlink" title="1. 内存排布"></a>1. 内存排布</h2><p>Linux 64位操作系统仅使用低<code>47</code>位，高<code>17</code>位做扩展（只能是全<code>0</code>或全<code>1</code>）。所以，实际用到的地址为空间为<code>0x0000000000000000 ~ 0x00007FFFFFFFFFFF</code>和<code>0xFFFF800000000000 ~ 0xFFFFFFFFFFFFFFFF</code>，其中前面为用户空间（User Space），后者为内核空间（Kernel Space）。图示如下：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1351548-a1aaad0873800e66.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><strong>【注】：</strong><a href="https://www.kernel.org/doc/Documentation/x86/x86_64/mm.txt" target="_blank" rel="noopener">Linux virtual memory map</a><br>对用户来说，主要关注的空间是User Space，其主要分为如下几段：</p>
<ul>
<li><code>Code</code>：这是整个用户空间的最低地址部分，存放的是指令（也就是程序所编译成的可执行机器码）</li>
<li><code>Data</code>：存放初始化过的全局变量</li>
<li><code>BSS</code>：存放未初始化的全局变量</li>
<li><code>Heap</code>：堆从低地址向高地址增长，<code>brk</code>相关的系统调用就是从这里分配内存</li>
<li><code>Mapping Area</code>：与<code>mmap</code>系统调用相关的区域（大多数实际的<code>malloc</code>实现会考虑通过<code>mmap</code>分配较大块的内存区域。此区域自高地址向低地址增长）</li>
<li><code>Stack</code>：栈区域，从高地址向低地址增长</li>
</ul>
<h2 id="2-Heap内存模型"><a href="#2-Heap内存模型" class="headerlink" title="2. Heap内存模型"></a>2. <code>Heap</code>内存模型</h2><p>一般来说，<code>malloc</code>所申请的内存主要从<code>Heap</code>区域分配（本文不考虑通过<code>mmap</code>申请大块内存的情况）。</p>
<p>进程所面对的虚拟内存地址空间，只有按页映射到物理内存地址，才能真正使用。受物理存储容量限制，整个堆虚拟内存空间不可能全部映射到实际的物理内存。Linux对堆的管理示意如下：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1351548-7190593cb6b16e7f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>Linux维护一个<code>break</code>指针，这个指针指向堆空间的某个地址</p>
<ul>
<li>从堆起始地址到<code>break</code>之间的地址空间为映射好的，可以供进程访问。</li>
<li>而从<code>break</code>往上，是未映射的地址空间，如果访问这段空间则程序会报错。</li>
</ul>
<h2 id="brk与sbrk"><a href="#brk与sbrk" class="headerlink" title="brk与sbrk"></a><code>brk</code>与<code>sbrk</code></h2><p>要增加一个进程实际的可用堆大小，就需要将<code>break</code>指针向高地址移动。Linux通过<code>brk</code>和<code>sbrk</code>系统调用操作<code>break</code>指针。两个系统调用的原型如下：</p>
<pre><code class="cpp">int brk(void *addr);
void *sbrk(intptr_t increment);
</code></pre>
<ul>
<li><code>brk</code>将<code>break</code>指针直接设置为某个地址。<code>brk</code>在执行成功时返回<code>0</code>，否则返回<code>-1</code>并设置<code>errno</code>为<code>ENOMEM</code>。</li>
<li><code>sbrk</code>将<code>break</code>从当前位置移动<code>increment</code>所指定的增量。<code>sbrk</code>成功时，返回<code>break</code>移动之前所指向的地址，否则返回<code>(void *)-1</code>。</li>
</ul>
<p><strong>【注】：</strong>如果将<code>increment</code>设置为<code>0</code>，则可以获得当前<code>break</code>的地址。</p>
<p>此外，由于Linux是按页进行内存映射的，所以如果<code>break</code>被设置为没有按页大小对齐，则系统实际上会在最后映射一个完整的页，从而实际已映射的内存空间比<code>break</code>指向的地方要大一些。但是使用<code>break</code>之后的地址是很危险的（尽管也许<code>break</code>之后确实有一小块可用内存地址）。</p>
<h2 id="4-资源限制与rlimit"><a href="#4-资源限制与rlimit" class="headerlink" title="4. 资源限制与rlimit"></a>4. 资源限制与<code>rlimit</code></h2><p>系统对每一个进程所分配的资源不是无限的，包括可映射的内存空间，因此每个进程有一个<code>rlimit</code>表示当前进程可用的资源上限。这个限制可以通过<code>getrlimit</code>系统调用得到。</p>
<p>获取当前进程虚拟内存空间的<code>rlimit</code>：</p>
<pre><code class="cpp">int main() {
    struct rlimit *limit = (struct rlimit *)malloc(sizeof(struct rlimit));
    getrlimit(RLIMIT_AS, limit);
    printf(&quot;soft limit: %ld, hard limit: %ld\n&quot;, limit-&gt;rlim_cur, limit-&gt;rlim_max);
}
</code></pre>
<p>其中，<code>rlimit</code>是一个结构体：</p>
<pre><code class="cpp">struct rlimit {
    rlim_t rlim_cur;  /* Soft limit */
    rlim_t rlim_max;  /* Hard limit (ceiling for rlim_cur) */
};
</code></pre>
<p>每种资源有软限制和硬限制，并且可以通过<code>setrlimit</code>对<code>rlimit</code>进行有条件设置。其中，硬限制作为软限制的上限，非特权进程只能设置软限制，且不能超过硬限制。</p>
<h2 id="实现malloc"><a href="#实现malloc" class="headerlink" title="实现malloc"></a>实现<code>malloc</code></h2><h3 id="1-采用的数据结构"><a href="#1-采用的数据结构" class="headerlink" title="1. 采用的数据结构"></a>1. 采用的数据结构</h3><p>首先需要确定所采用的数据结构。一个简单可行的方案是：<strong>将堆内空间以块（block）的形式组织起来，每个块由<code>meta</code>区和数据区组成。其中，<code>meta</code>区记录数据块的meta information（元信息，数据区的大小、空闲标志位、指针等），数据区是真实分配的内存区域，并且数据区的第一个字节地址即为<code>malloc</code>返回的地址</strong>。</p>
<p>定义一个结构体<code>block</code>：</p>
<pre><code class="cpp">typedef struct s_block *t_block;
struct s_block {
    size_t size;  /* 数据区大小 */
    t_block next; /* 指向下个块的指针 */
    bool is_free;     /* 是否是空闲块 */
    int padding;  /* 填充4字节，保证meta块长度为8的倍数 */
    char data[1]  /* 这是一个虚拟字段，表示数据块的第一个字节，长度不应计入meta */
};
</code></pre>
<p>由于我们只考虑64位机器，为了方便，我们在结构体最后填充一个<code>int</code>，使得结构体本身的长度为<code>8</code>的倍数，以便内存对齐。示意图如下：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1351548-49ff9a199a5c72f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="2-寻找合适的block"><a href="#2-寻找合适的block" class="headerlink" title="2. 寻找合适的block"></a>2. 寻找合适的<code>block</code></h3><p>在<code>block</code>链中查找合适的<code>block</code>，一般有两种查找算法：</p>
<ul>
<li>first fit：从头开始，查找第一个数据区大小大于或者等于要求<code>size</code>的块，作为此次分配的块。</li>
<li>best fit：从头开始，遍历所有块，查找数据区大小大于<code>size</code>且差值最小的块，作为此次分配的块。</li>
</ul>
<p>best fit具有较高的内存使用率（payload较高），而first fit具有更好的运行效率。此处，采用first fit算法：</p>
<pre><code class="cpp">/* First fit */
t_block find_block(t_block *cur, size_t size) {
    t_block b = first_block;
    while(b &amp;&amp; !(b-&gt;is_free &amp;&amp; b-&gt;size &gt;= size)) {
        *cur = b;
        b = b-&gt;next;
    }
    return b;
}
</code></pre>
<p><code>find_block()</code>从<code>frist_block</code>开始，查找第一个符合要求的<code>block</code>，并返回<code>block</code>起始地址。如果找不到，便返回<code>NULL</code>。在遍历时会更新一个叫<code>cur</code>的指针，这个指针始终指向当前遍历的<code>block</code>。<code>cur</code>的作用是：如果找不到合适的<code>block</code>，便需要重新开辟新的<code>block</code>，这时便会用到它。</p>
<h3 id="3-开辟新的block"><a href="#3-开辟新的block" class="headerlink" title="3. 开辟新的block"></a>3. 开辟新的<code>block</code></h3><p>如果现有的<code>block</code>都不能满足<code>size</code>的要求，则需要在链表的最后开辟一个新的<code>block</code>。关键是：<strong>如何只使用<code>sbrk</code>创建一个<code>struct</code>：</strong></p>
<pre><code class="cpp">#define BLOCK_SIZE 24 /* 由于存在虚拟的data字段，sizeof不能正确计算meta长度，这里手工设置 */

t_block extend_heap(t_block cur, size_t s) {
    t_block b;
    b = sbrk(0);
    if(sbrk(BLOCK_SIZE + s) == (void *)-1)    // 如果从heap上分配内存失败，则直接返回NULL
        return NULL;
    b-&gt;size = s;
    b-&gt;next = NULL;
    if(cur)      // 在当前指定的block后插入刚分配的block
        cur-&gt;next = b;
    b-&gt;free = 0;
    return b;
}
</code></pre>
<h3 id="分裂block"><a href="#分裂block" class="headerlink" title="分裂block"></a>分裂<code>block</code></h3><p>First fit有一个比较致命的缺点：<strong>可能会让很小的<code>size</code>占据很大的一块<code>block</code>。此时，为了提高payload，应该在剩余数据区足够大的情况下，将其分裂为一个新的<code>block</code>。</strong></p>
<p>示意图如下：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1351548-613e96af682bba14.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>实现为：</p>
<pre><code class="c++">void split_block(t_block b, size_t s) {
    t_block new_block;
    new_block = b-&gt;data + s;
    new_block-&gt;size = b-&gt;size - s - BLOCK_SIZE ;
    new_block-&gt;next = b-&gt;next;
    new_block-&gt;free = 1;
    b-&gt;size = s;
    b-&gt;next = new_block;
}
</code></pre>
<h3 id="malloc的实现"><a href="#malloc的实现" class="headerlink" title="malloc的实现"></a><code>malloc</code>的实现</h3><p>由于希望<code>malloc</code>分配的数据区是按<code>8</code>字节进行对齐，所以当<code>size</code>不为<code>8</code>的倍数时，需要将<code>size</code>调整为大于<code>size</code>的最小的<code>8</code>的倍数。</p>
<pre><code class="cpp">size_t align(size_t s) {
    if(s &amp; 0x7 == 0)
        return s;
    return ((s &gt;&gt; 3) + 1) &lt;&lt; 3;
    // return ((s + 7) &amp; -8);    ((size_t)s + n-1) &amp; -n);
}
</code></pre>
<p><code>malloc</code> 的具体实现：</p>
<pre><code class="cpp">#define BLOCK_SIZE 24
void *first_block=NULL;

/* other functions... */

void *malloc(size_t size) {
    t_block b, last;
    size_t s;
    /* 对齐地址 */
    s = align(size);
    if(first_block) {
        /* 查找合适的block */
        last = first_block;
        b = find_block(&amp;last, s);
        if(b) {
            /* 如果可以，则分裂 */
            if ((b-&gt;size - s) &gt;= ( BLOCK_SIZE + 8))
                split_block(b, s);
            b-&gt;free = 0;
        } else {
            /* 没有合适的block，开辟一个新的 */
            b = extend_heap(last, s);
            if(!b)
                return NULL;
        }
    } else {
        b = extend_heap(NULL, s);
        if(!b)
            return NULL;
        first_block = b;
    }
    return b-&gt;data;
}
</code></pre>
<h3 id="calloc的实现"><a href="#calloc的实现" class="headerlink" title="calloc的实现"></a><code>calloc</code>的实现</h3><p>在内存的动态存储区中分配n个长度为<code>size</code>的连续空间，函数返回一个指向分配起始地址的指针；如果分配不成功，返回<code>NULL</code>。</p>
<p>实现<code>calloc</code>的步骤：</p>
<ol>
<li><code>malloc</code>一段内存</li>
<li>将数据区内容设置为<code>0</code></li>
</ol>
<p>由于数据区是按<code>8</code>字节对齐的，所以为了提高效率，可以每<code>8</code>字节一组置<code>0</code>，而不是一个一个字节设置。可以通过新建一个<code>size_t</code>指针，将内存区域强制看做<code>size_t</code>类型来实现。</p>
<pre><code class="cpp">void *calloc(size_t n, size_t size) {
    size_t *new_block;
    size_t s, i;
    new_block = malloc(n * size);
    if(new_block) {
        s = align(n * size) &gt;&gt; 3;
        for(i = 0; i &lt; s; i++)
            new_block[i] = 0;
    }
    return new_block;
}
</code></pre>
<h3 id="free的实现"><a href="#free的实现" class="headerlink" title="free的实现"></a><code>free</code>的实现</h3><p><code>free</code>的实现需要解决两个关键问题：</p>
<ol>
<li>如何验证所传入的地址是有效地址，即确实是通过<code>malloc</code>方式分配的数据区首地址</li>
<li>如何解决碎片问题</li>
</ol>
<p>首先要保证传入<code>free</code>的地址是有效的，这个有效包括两方面：</p>
<ol>
<li>地址应该在<code>malloc</code>所分配的区域内，即在<code>first_block</code>和当前<code>break</code>指针范围内</li>
<li>这个地址是由之前自己实现的<code>malloc</code>分配</li>
</ol>
<p>第一个问题比较好解决，只需要进行地址比较便可，关键是第二个问题。有两种解决方案：</p>
<ol>
<li>在结构体内设置一个<code>magic number</code>字段，<code>free</code>之前通过相对偏移，检查特定位置的值是否为设置的<code>magic number</code></li>
<li>在结构体内增加一个<code>magic pointer</code>，此指针指向数据区的第一个字节（也就是在合法时<code>free</code>时传入的地址），在<code>free</code>前检查<code>magic pointer</code>是否指向参数所指地址。</li>
</ol>
<p>此处采用第二种方案。首先，在结构体中增加<code>magic pointer</code>（同时需要修改<code>BLOCK_SIZE</code>）：</p>
<pre><code class="cpp">typedef struct s_block *t_block;
struct s_block {
    size_t size;  /* 数据区大小 */
    t_block next; /* 指向下个块的指针 */
    int free;     /* 是否是空闲块 */
    int padding;  /* 填充4字节，保证meta块长度为8的倍数 */
    void *ptr;    /* Magic pointer，指向data */
    char data[1]  /* 这是一个虚拟字段，表示数据块的第一个字节，长度不应计入meta */
};
</code></pre>
<p>然后，定义检查地址合法性的函数：</p>
<pre><code class="cpp">t_block get_block(void *p) {
    char *tmp;  
    tmp = p;
    return (p = tmp -= BLOCK_SIZE);
}

int valid_addr(void *p) {
    if(first_block) {
        if(p &gt; first_block &amp;&amp; p &lt; sbrk(0)) {
            return p == (get_block(p))-&gt;ptr;
        }
    }
    return 0;
}
</code></pre>
<p>当多次<code>malloc</code>和<code>free</code>后，整个内存池可能会产生很多碎片<code>block</code>，这些<code>block</code>很小，经常无法使用，甚至出现许多碎片连在一起，虽然总体能满足某些<code>malloc</code>要求，但是由于分割成了多个小<code>block</code>而无法<code>fit</code>，这就是碎片问题。</p>
<p>一个简单的解决方式是：当<code>free</code>某个<code>block</code>时，如果发现它相邻的<code>block</code>也是<code>free</code>的，则将此<code>block</code>和相邻<code>block</code>进行合并。为了满足这个实现，则需要将<code>s_block</code>改为双向链表。修改后的<code>block</code>结构如下：</p>
<pre><code class="cpp">typedef struct s_block *t_block;
struct s_block {
    size_t size;  /* 数据区大小 */
    t_block prev; /* 指向上个块的指针 */
    t_block next; /* 指向下个块的指针 */
    int free;     /* 是否是空闲块 */
    int padding;  /* 填充4字节，保证meta块长度为8的倍数 */
    void *ptr;    /* Magic pointer，指向data */
    char data[1]  /* 这是一个虚拟字段，表示数据块的第一个字节，长度不应计入meta */
};
</code></pre>
<p>合并方法为：</p>
<pre><code class="cpp">t_block fusion(t_block b) {
    if (b-&gt;next &amp;&amp; b-&gt;next-&gt;free) {
        b-&gt;size += BLOCK_SIZE + b-&gt;next-&gt;size;
        b-&gt;next = b-&gt;next-&gt;next;
        if(b-&gt;next)
            b-&gt;next-&gt;prev = b;
    }
    return b;
}
</code></pre>
<p>有了上述方法，<code>free</code>的实现思路就比较清晰了：首先检查参数地址的合法性，如果不合法，则不做任何事；否则，将此<code>block</code>的<code>free</code>设置为<code>1</code>，并且在可以的情况下与后面的<code>block</code>进行合并。如果当前是最后一个<code>block</code>，则回退<code>break</code>指针释放进程内存，如果当前<code>block</code>是最后一个<code>block</code>，则回退break指针并设置first_block为NULL。实现如下：</p>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/10/25/SIFT/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="Magicmanoooo's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        838713968@qq.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto: 838713968@qq.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/10/">十月 2018<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/09/">九月 2018<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/08/">八月 2018<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/07/">七月 2018<span class="sidebar_archives-count">5</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                
            </ul>
        </li>
        
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">17</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->


<!-- Help & Support -->
<!--

    <a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
        sidebar.help
        <span class="mdl-button__ripple-container">
          <span class="mdl-ripple"></span>
        </span>
      </div>
    </a>

-->

<!-- Feedback -->
<!--

    <a href="https://github.com/viosey/hexo-theme-material/issues" target="_blank" class="sidebar-footer-text-a">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
        sidebar.feedback
        <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
    </a>

-->

<!-- About Theme -->
<!--

    <a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
             sidebar.about_theme
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
    </a>

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    
        <a href="https://weibo.com/5345088988/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo&amp;is_all=1" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-weibo">
                <span class="visuallyhidden">Weibo</span>
            </button><!--
     --></a>
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/Azurery" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    
        <a href="https://www.zhihu.com/people/zhang-tao-60-41/activities" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-zhihu">
                <span class="visuallyhidden">Zhihu</span>
            </button><!--
     --></a>
    

    <!-- Bilibili -->
    
        <a href="https://space.bilibili.com/94222521/#/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-bilibili">
                <span class="visuallyhidden">Bilibili</span>
            </button><!--
     --></a>
    

    <!-- Telegram -->
    
    
    <!-- V2EX -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;2017&nbsp;-<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Azurery
            
                <br>
                
                    只有永不遏止的奋斗，才能使青春之花，即使是凋谢，也是壮丽地凋谢
                
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->

    
        
            <script>lsloader.load("prettify_js","/js/prettify.min.js?WN07fivHQSMKWy7BmHBB6w==", true)</script>
        
    



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
        
            $(function() {
                $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
                prettyPrint();
                })
        
    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
